#!/bin/bash
# çŽ¯å¢ƒå˜é‡è¯´æ˜Ž:
# TRIM_APPDEST    - åº”ç”¨å¯æ‰§è¡Œæ–‡ä»¶ç›®å½• (targetç›®å½•)   -> @appcenter
# TRIM_PKGVAR     - åº”ç”¨æ•°æ®ç›®å½• (varç›®å½•)           -> @appdata
# TRIM_PKGETC     - åº”ç”¨é…ç½®ç›®å½• (etcç›®å½•)           -> @appconf
# TRIM_PKGHOME    - åº”ç”¨homeç›®å½• (homeç›®å½•)          -> @apphome
# TRIM_PKGTMP     - åº”ç”¨ä¸´æ—¶ç›®å½• (tmpç›®å½•)           -> @apptemp
# TRIM_SHARES     - åº”ç”¨å…±äº«ç›®å½• (sharesç›®å½•)        -> @appshare
# TRIM_SERVICE_PORT - æœåŠ¡ç«¯å£

# å°† Python è·¯å¾„åŠ å…¥çŽ¯å¢ƒ (æºç ç‰ˆéœ€è¦ï¼ŒäºŒè¿›åˆ¶ç‰ˆå¿½ç•¥å³å¯)
export PATH=/var/apps/python312/target/bin:$PATH

LOG_FILE="${TRIM_PKGVAR}/info.log"
PID_FILE="${TRIM_PKGVAR}/app.pid"
MUSIC_LIBRARY_PATH="${TRIM_PKGVAR}/Music"

# ========================================================
# è‡ªåŠ¨å…¼å®¹é€»è¾‘ï¼šæ£€æµ‹æ˜¯ äºŒè¿›åˆ¶ç‰ˆ è¿˜æ˜¯ æºç ç‰ˆ

# å®šä¹‰å¯èƒ½çš„è·¯å¾„
BINARY_APP="${TRIM_APPDEST}/server/app"
SOURCE_APP="${TRIM_APPDEST}/server/app.py"
# å®šä¹‰é€šç”¨çš„å¯åŠ¨å‚æ•°
APP_ARGS="--music-library-path ${MUSIC_LIBRARY_PATH} --log-path ${LOG_FILE} --port 23237"

if [ -f "${BINARY_APP}" ]; then
    # ðŸ”¹ Case 1: å‘çŽ°äºŒè¿›åˆ¶æ–‡ä»¶ (Auto Build Binary Version)
    # ç¡®ä¿æœ‰æ‰§è¡Œæƒé™
    chmod +x "${BINARY_APP}"
    CMD="${BINARY_APP} ${APP_ARGS}"
    MODE="Binary"
else
    # ðŸ”¸ Case 2: æœªå‘çŽ°äºŒè¿›åˆ¶ï¼Œå›žé€€åˆ° Python æºç  (Source Version)
    CMD="python3 ${SOURCE_APP} ${APP_ARGS}"
    MODE="Source(Python)"
fi

# ========================================================

log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> ${LOG_FILE}
}

start_process() {
    if status; then
        return 0
    fi

    log_msg "Starting process (Mode: ${MODE}) ..."
    log_msg "Command: ${CMD}"
    
    # run cmd to start process
    bash -c "${CMD}" &
    # write pid to pidfile
    printf "%s" "$!" > ${PID_FILE}
    
    return 0
}

stop_process() {
    log_msg "Stopping process ..."

    if [ -r "${PID_FILE}" ]; then
        pid=$(head -n 1 "${PID_FILE}" | tr -d '[:space:]')
        
        log_msg "pid=${pid}"
        if ! check_process "${pid}"; then
            # process not exist, delete pidfile
            rm -f "${PID_FILE}"
            log_msg "remove pid file 1"
            return
        fi

        log_msg "send TERM signal to PID:${pid}..."
        kill -TERM ${pid} >> ${LOG_FILE} 2>&1

        local count=0
        while check_process "${pid}" && [ $count -lt 10 ]; do
            sleep 1
            count=$((count + 1))
            log_msg "waiting process terminal... (${count}s/10s)"
        done

        if check_process "${pid}"; then
            log_msg "send KILL signal to PID:${pid}..."
            kill -KILL "${pid}"
            sleep 1
            rm -f "${PID_FILE}"
        else
            log_msg "process killed... "
        fi
    fi

    return 0
}

check_process() {
    local pid=$1
    if kill -0 "${pid}" 2>/dev/null; then
        return 0  # process exist
    else
        return 1  # process not exist
    fi
}

status() {
    if [ -f "${PID_FILE}" ]; then
        pid=$(head -n 1 "${PID_FILE}" | tr -d '[:space:]')
        if check_process "${pid}"; then
            return 0
        else
            # Process is not running but pidfile exists - clean it up
            rm -f "${PID_FILE}"
        fi    
    fi

    return 1
}

case $1 in
start)
    # run start command. exit 0 if success, exit 1 if failed
    start_process
    ;;
stop)
    # run stop command. exit 0 if success, exit 1 if failed
    stop_process
    ;;
status)
    # check application status command. exit 0 if running, exit 3 if not running
    if status; then 
        exit 0
    else 
        exit 3
    fi
    ;;
*)
    exit 1
    ;;
esac
