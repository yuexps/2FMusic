name: Build Source on App Change

on:
  push:
    paths:
      - 'app/**'
    # app/ å˜åŠ¨æ—¶è§¦å‘
    # manifest å˜åŠ¨æ—¶ä¸è§¦å‘æœ¬æµç¨‹

jobs:
  build-source-if-version-unchanged:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check manifest version unchanged
        id: check_version
        run: |
          VER_NOW=$(grep "^version" manifest | awk -F'=' '{print $2}' | xargs)
          VER_OLD=$(git show HEAD^:manifest 2>/dev/null | grep "^version" | awk -F'=' '{print $2}' | xargs || echo "")
          echo "Current Version: $VER_NOW"
          echo "Previous Version: $VER_OLD"
          if [ "$VER_NOW" != "$VER_OLD" ]; then
            echo "Manifest version changed, skip this workflow."
            exit 1
          fi
          echo "Manifest version unchanged, continue build."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Prepare fnpack
        run: |
          cp ./fnpack-1.0.4-linux-amd64 ./fnpack
          chmod +x ./fnpack

      - name: Extract Version from Manifest
        id: version
        run: |
          VERSION_NUM=$(grep "^version" manifest | awk -F'=' '{print $2}' | xargs)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="${VERSION_NUM}-${SHORT_SHA}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build Source Package (Python)
        id: build_source
        run: |
          echo "ðŸ“¦ Building Source (Python) Package..."
          fnpack build
          SOURCE_FPK_NAME="2fmusic-${{ steps.version.outputs.version }}-python.fpk"
          if [ -f "2fmusic.fpk" ]; then
            mv 2fmusic.fpk "$SOURCE_FPK_NAME"
            echo "Built: $SOURCE_FPK_NAME"
          else
            echo "Error: 2fmusic.fpk not found!"
            exit 1
          fi
          echo "source_pkg=$SOURCE_FPK_NAME" >> $GITHUB_OUTPUT

      - name: Upload Source FPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: 2fmusic-source-fpk
          path: ${{ steps.build_source.outputs.source_pkg }}
          if-no-files-found: error
