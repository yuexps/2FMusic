name: Auto Build 2FMusic (Dual Versions)

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:              # å…è®¸ä»£ç æ¨é€è§¦å‘
    paths:
      - 'manifest'   # åªæœ‰å½“ manifest æ–‡ä»¶å‘ç”Ÿå˜åŠ¨æ—¶æ‰è‡ªåŠ¨è§¦å‘æ„å»º

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 0. æ£€æŸ¥ manifest ç‰ˆæœ¬å·æ˜¯å¦å˜æ›´
    - name: Check Version Change
      if: github.event_name == 'push'
      run: |
        VER_NOW=$(grep "^version=" manifest | cut -d= -f2 | xargs)
        # è·å–ä¸Šä¸€ commit çš„æ–‡ä»¶å†…å®¹ (å…¼å®¹é¦–æ¬¡ commit æƒ…å†µ)
        VER_OLD=$(git show HEAD^:manifest 2>/dev/null | grep "^version=" | cut -d= -f2 | xargs || echo "")
        
        echo "Current Version: $VER_NOW"
        echo "Previous Version: $VER_OLD"
        
        if [ "$VER_NOW" == "$VER_OLD" ]; then
          echo "â›” Version number not changed in manifest. Skipping build."
          # æ‰‹åŠ¨å¤±è´¥ä»¥åœæ­¢æµç¨‹
          exit 1
        fi
        echo "âœ… Version change detected."

    # 1. ä» manifest æå–ç‰ˆæœ¬å· + Commit Hash
    - name: Extract Version from Manifest
      id: version
      run: |
        VERSION_NUM=$(grep "^version" manifest | awk -F'=' '{print $2}' | xargs)
        SHORT_SHA=$(git rev-parse --short HEAD)
        
        # ç»„åˆç‰ˆæœ¬å·: 0.0.1-a1b2c3d
        VERSION="${VERSION_NUM}-${SHORT_SHA}"
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Detected version: ${VERSION}"

    # 1.1 ç”Ÿæˆå˜æ›´æ—¥å¿— (Since last tag)
    - name: Generate Changelog
      id: changelog
      run: |
        echo "ğŸ“œ Generating changelog..."
        # å°è¯•æ‰¾åˆ°æœ€è¿‘çš„ä¸€ä¸ª Tag
        PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          echo "No previous tag found. Logging last 20 commits."
          LOGS=$(git log --pretty=format:"- %s (%h) @%an" -n 20)
        else
          echo "Found previous tag: $PREV_TAG"
          # ç®€å•å¤„ç†ï¼šæ˜¾ç¤ºè¯¥ Tag ä¹‹åçš„æ‰€æœ‰å˜æ›´
          LOGS=$(git log --pretty=format:"- %s (%h) @%an" ${PREV_TAG}..HEAD)
        fi
        
        # å¦‚æœæ—¥å¿—ä¸ºç©ºï¼ˆä¾‹å¦‚æ²¡æœ‰æ–°æäº¤ï¼‰ï¼Œæ˜¾ç¤º "No changes detected"
        if [ -z "$LOGS" ]; then
          LOGS="- No changes detected or rebuild of same commit."
        fi
        
        # å¤„ç†å¤šè¡Œè¾“å‡ºåˆ° GITHUB_OUTPUT
        {
          echo "logs<<EOF"
          echo "$LOGS"
          echo "EOF"
        } >> $GITHUB_OUTPUT

    # 2. è®¾ç½® Python ç¯å¢ƒ (å¯ç”¨ç¼“å­˜)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    # 3. å®‰è£…ç¼–è¯‘å·¥å…·å’Œç¯å¢ƒä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
        # ä¸ºäº†è®© PyInstaller èƒ½æ­£ç¡®åˆ†æä¾èµ–ï¼Œåœ¨ Runner ç¯å¢ƒä¸­å®‰è£…å®ƒä»¬
        if [ -f app/server/requirements.txt ]; then 
           pip install -r app/server/requirements.txt
        fi

    # 4. å®‰è£… fnpack
    - name: Install fnpack
      run: |
        wget https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64 -O fnpack
        chmod +x fnpack
        sudo mv fnpack /usr/local/bin/

    # ==========================================
    # 5. æ„å»ºç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼šæºç ç‰ˆ (Python Version)
    # ==========================================
    - name: Build Source Package (Requires Python)
      id: build_source
      run: |
        echo "ğŸ“¦ Building Source (Python) Package..."
        fnpack build
        
        SOURCE_FPK_NAME="2fmusic-${{ steps.version.outputs.version }}-python.fpk"
        
        if [ -f "2fmusic.fpk" ]; then
          mv 2fmusic.fpk "$SOURCE_FPK_NAME"
        else
          echo "Error: 2fmusic.fpk not found!"
          exit 1
        fi
        
        echo "source_pkg=${SOURCE_FPK_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Generated: $SOURCE_FPK_NAME"

    # ==========================================
    # 6. ç¯å¢ƒè½¬æ¢ï¼šç¼–è¯‘äºŒè¿›åˆ¶ & æ¸…ç†æºç 
    # ==========================================
    - name: Compile and Cleanup for Binary
      run: |
        echo "ğŸ”¨ Compiling app.py to binary..."
        pyinstaller --clean --onefile --name "app" --icon="app/www/static/images/ICON_256.PNG" --distpath "app/server" "app/server/app.py"
        
        chmod +x app/server/app
        
        echo "ğŸ§¹ Cleaning up source files..."
        rm -rf build/
        rm -f app.spec
        
        # åˆ é™¤æºç å’Œä¾èµ–åº“
        rm -f app/server/app.py
        rm -rf app/server/lib
        
        echo "ğŸ“ Modifying manifest (Remove Python dependency)..."
        sed -i '/install_dep_apps/d' manifest
        
        echo "âœ… Ready for Binary Build."

    # ==========================================
    # 7. æ„å»ºç¬¬äºŒä¸ªç‰ˆæœ¬ï¼šäºŒè¿›åˆ¶ç‰ˆ (Binary Version)
    # ==========================================
    - name: Build Binary Package (Standalone)
      id: build_binary
      run: |
        echo "ğŸ“¦ Building Binary (Standalone) Package..."
        fnpack build
        
        BINARY_FPK_NAME="2fmusic-${{ steps.version.outputs.version }}-amd64.fpk"
        
        if [ -f "2fmusic.fpk" ]; then
          mv 2fmusic.fpk "$BINARY_FPK_NAME"
        else
          echo "Error: 2fmusic.fpk not found!"
          exit 1
        fi
        
        echo "binary_pkg=${BINARY_FPK_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Generated: $BINARY_FPK_NAME"

    # ==========================================
    # 7.1 æ„å»ºæ‰©å±•åŒ…ï¼šé¢„è§ˆåŠŸèƒ½ (Preview Extension)
    # ==========================================
    - name: Build Preview Extension
      id: build_preview
      run: |
        echo "ğŸ“¦ Building Preview Extension..."
        cd extensions/preview
        fnpack build
        
        PREVIEW_FPK_NAME="2fmusic-preview-${{ steps.version.outputs.version }}.fpk"
        
        if [ -f "2fmusic-preview.fpk" ]; then
          mv 2fmusic-preview.fpk "../../$PREVIEW_FPK_NAME"
        else
          # Fallback: fnpack might name it based on appname
          mv *.fpk "../../$PREVIEW_FPK_NAME" || echo "Warning: No fpk found in $(pwd)"
        fi
        
        cd ../..
        echo "preview_pkg=${PREVIEW_FPK_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Generated: $PREVIEW_FPK_NAME"

    # 8. åˆ é™¤æ—§çš„åŒç‰ˆæœ¬ Release
    - name: Delete old Pre-release
      run: |
        TAG="v${{ steps.version.outputs.version }}-pre"
        gh release delete "$TAG" --yes || true
        git push --delete origin "$TAG" || true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 9. åˆ›å»ºå‘å¸ƒå¹¶ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶
    - name: Create Pre-release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}-pre
        name: 2FMusic ${{ steps.version.outputs.version }} (Dual Versions)
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºçš„æµ‹è¯•ç‰ˆ

          ### â„¹ï¸ æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
          - **è§¦å‘è€…**: @${{ github.actor }}
          - **äº‹ä»¶**: ${{ github.event_name }}
          
          ### ğŸ“ å˜æ›´æ—¥å¿—
          ${{ steps.changelog.outputs.logs }}

          ---

          ### 1. ğŸ Python æºç ç‰ˆ
          - **æ–‡ä»¶**: `${{ steps.build_source.outputs.source_pkg }}`
          - **ä¾èµ–**: ä¾èµ– Python ç¯å¢ƒ (`python312`)ã€‚
          
          ### 2. âš¡ äºŒè¿›åˆ¶ç‰ˆ
          - **æ–‡ä»¶**: `${{ steps.build_binary.outputs.binary_pkg }}`
          - **ä¾èµ–**: **æ— éœ€** Python ç¯å¢ƒï¼Œå¼€ç®±å³ç”¨ã€‚

          ### 3. ğŸ§© é¢„è§ˆåŠŸèƒ½æ‰©å±•åŒ… (å¯é€‰)
          - **æ–‡ä»¶**: `${{ steps.build_preview.outputs.preview_pkg }}`
          - **è¯´æ˜**: å®‰è£…æ­¤åŒ…ä»¥å¯ç”¨ç³»ç»Ÿæ–‡ä»¶é¢„è§ˆåŠŸèƒ½ï¼ˆéœ€å…ˆå®‰è£…ä¸»åº”ç”¨ï¼‰ã€‚

        files: |
          ${{ steps.build_source.outputs.source_pkg }}
          ${{ steps.build_binary.outputs.binary_pkg }}
          ${{ steps.build_preview.outputs.preview_pkg }}
        prerelease: true
        make_latest: true
        draft: false
