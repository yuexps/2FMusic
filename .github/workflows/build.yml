name: Auto Build 2FMusic

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'manifest'   # åªæœ‰å½“ manifest ç‰ˆæœ¬å·å‘ç”Ÿå˜åŠ¨æ—¶æ‰è‡ªåŠ¨è§¦å‘æ„å»º

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 0. æ£€æŸ¥ manifest ç‰ˆæœ¬å·æ˜¯å¦å˜æ›´
    - name: Check Version Change
      if: github.event_name == 'push'
      run: |
        VER_NOW=$(grep "^version" manifest | awk -F'=' '{print $2}' | xargs)
        # è·å–ä¸Šä¸€ commit çš„æ–‡ä»¶å†…å®¹ (HEAD^:manifest)
        VER_OLD=$(git show HEAD^:manifest 2>/dev/null | grep "^version" | awk -F'=' '{print $2}' | xargs || echo "")
        
        echo "Current Version: $VER_NOW"
        echo "Previous Version: $VER_OLD"
        
        if [ "$VER_NOW" == "$VER_OLD" ]; then
          echo "â›” Version number not changed in manifest. Skipping build."
          # æ‰‹åŠ¨å¤±è´¥ä»¥åœæ­¢æµç¨‹
          exit 1
        fi
        echo "âœ… Version change detected."

    # 1. ä» manifest æå–ç‰ˆæœ¬å· + Commit Hash
    - name: Extract Version from Manifest
      id: version
      run: |
        VERSION_NUM=$(grep "^version" manifest | awk -F'=' '{print $2}' | xargs)
        SHORT_SHA=$(git rev-parse --short HEAD)
        
        # ç»„åˆç‰ˆæœ¬å·: 0.0.1-a1b2c3d
        VERSION="${VERSION_NUM}-${SHORT_SHA}"
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Detected version: ${VERSION}"

    # 1.1 ç”Ÿæˆå˜æ›´æ—¥å¿— (Since last tag)
    - name: Generate Changelog
      id: changelog
      run: |
        echo "ğŸ“œ Generating changelog..."
        # å°è¯•æ‰¾åˆ°æœ€è¿‘çš„ä¸€ä¸ª Tag
        PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          echo "No previous tag found. Logging last 20 commits."
          LOGS=$(git log --pretty=format:"- %s (%h) @%an" -n 20)
        else
          echo "Found previous tag: $PREV_TAG"
          # ç®€å•å¤„ç†ï¼šæ˜¾ç¤ºè¯¥ Tag ä¹‹åçš„æ‰€æœ‰å˜æ›´
          LOGS=$(git log --pretty=format:"- %s (%h) @%an" ${PREV_TAG}..HEAD)
        fi
        
        # å¦‚æœæ—¥å¿—ä¸ºç©ºï¼ˆä¾‹å¦‚æ²¡æœ‰æ–°æäº¤ï¼‰ï¼Œæ˜¾ç¤º "No changes detected"
        if [ -z "$LOGS" ]; then
          LOGS="- No changes detected or rebuild of same commit."
        fi
        
        # å¤„ç†å¤šè¡Œè¾“å‡ºåˆ° GITHUB_OUTPUT
        {
          echo "logs<<EOF"
          echo "$LOGS"
          echo "EOF"
        } >> $GITHUB_OUTPUT

    # 2. è®¾ç½® Python ç¯å¢ƒ (å¯ç”¨ç¼“å­˜)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    # 3. å®‰è£…ç¼–è¯‘å·¥å…·å’Œç¯å¢ƒä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
        # ä¸ºäº†è®© PyInstaller èƒ½æ­£ç¡®åˆ†æä¾èµ–ï¼Œåœ¨ Runner ç¯å¢ƒä¸­å®‰è£…å®ƒä»¬
        if [ -f app/server/requirements.txt ]; then 
           pip install -r app/server/requirements.txt
        fi

    # 4. å®‰è£… fnpack
    - name: Install fnpack
      run: |
        cp build/fnpack-1.2.1-linux-amd64 ./fnpack
        chmod +x ./fnpack

    # ==========================================
    # 5. æ„å»ºç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼šæºç ç‰ˆ (Python Version)
    # ==========================================
    - name: Build Source Package (Requires Python)
      id: build_source
      run: |
        echo "ğŸ“¦ Building Source (Python) Package..."
        ./fnpack build
        
        SOURCE_FPK_NAME="fnnas.2fmusic-${{ steps.version.outputs.version }}-python.fpk"
        
        if [ -f "fnnas.2fmusic.fpk" ]; then
          mv fnnas.2fmusic.fpk "$SOURCE_FPK_NAME"
        else
          echo "Error: fnnas.2fmusic.fpk not found!"
          exit 1
        fi
        
        echo "source_pkg=${SOURCE_FPK_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Generated: $SOURCE_FPK_NAME"

    # ==========================================
    # 6. ç¯å¢ƒè½¬æ¢ï¼šç¼–è¯‘äºŒè¿›åˆ¶ & æ¸…ç†æºç 
    # ==========================================
    - name: Compile and Cleanup for Binary
      run: |
        echo "ğŸ”¨ Compiling app.py to binary..."
        pyinstaller --clean --onefile --name "app" --paths "app/server/lib" --paths "app/server/mod" --icon="app/www/static/images/ICON_256.PNG" --distpath "app/server" "app/server/app.py"
        
        chmod +x app/server/app
        
        echo "ğŸ§¹ Cleaning up source files..."
        rm -rf build/
        rm -f app.spec
        
        # åˆ é™¤æºç å’Œä¾èµ–åº“
        rm -f app/server/app.py
        rm -rf app/server/lib
        
        echo "ğŸ“ Modifying manifest (Remove Python dependency)..."
        sed -i '/install_dep_apps/d' manifest
        
        echo "âœ… Ready for Binary Build."

    # ==========================================
    # 7. æ„å»ºç¬¬äºŒä¸ªç‰ˆæœ¬ï¼šäºŒè¿›åˆ¶ç‰ˆ (Binary Version)
    # ==========================================
    - name: Build Binary Package (Standalone)
      id: build_binary
      run: |
        echo "ğŸ“¦ Building Binary (Standalone) Package..."
        ./fnpack build
        
        BINARY_FPK_NAME="fnnas.2fmusic-${{ steps.version.outputs.version }}-amd64.fpk"
        
        if [ -f "fnnas.2fmusic.fpk" ]; then
          mv fnnas.2fmusic.fpk "$BINARY_FPK_NAME"
        else
          echo "Error: fnnas.2fmusic.fpk not found!"
          exit 1
        fi
        
        echo "binary_pkg=${BINARY_FPK_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Generated: $BINARY_FPK_NAME"

    # ===============================
    # 8. æ„å»º2FMusic Preview (CGI)
    # ===============================
    - name: Build Preview (CGI)
      id: build_preview_cgi
      run: |
        echo "ğŸ“¦ Building Preview Extension (CGI)..."
        mv ./fnpack extensions/preview-cgi/fnpack
        cd extensions/preview-cgi
        
        # Compile C Code
        echo "ğŸ”¨ Compiling index.c..."
        gcc -static -O2 -o app/ui/index.cgi app/ui/index.c
        chmod +x app/ui/index.cgi
        rm app/ui/index.c
        
        # Package
        ./fnpack build
        
        # Get Version from Manifest
        VERSION=$(grep "^version" manifest | awk -F'=' '{print $2}' | tr -d '[:space:]')
        SHORT_SHA=$(git rev-parse --short HEAD)
        PKG_NAME="fnnas.2fmusic-preview-cgi-${VERSION}-${SHORT_SHA}.fpk"
        
        # Find and Move
        if [ -f "fnnas.2fmusic-preview-cgi.fpk" ]; then
          mv fnnas.2fmusic-preview-cgi.fpk "../../$PKG_NAME"
        else
          mv *.fpk "../../$PKG_NAME" || echo "Warning: No fpk found!"
        fi
        
        cd ../..
        echo "pkg_name=${PKG_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Built: $PKG_NAME"

    # 9. åˆ é™¤æ—§çš„åŒç‰ˆæœ¬ Release
    - name: Delete old Pre-release
      run: |
        TAG="v${{ steps.version.outputs.version }}-pre"
        gh release delete "$TAG" --yes || true
        git push --delete origin "$TAG" || true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 10. åˆ›å»ºå‘å¸ƒå¹¶ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶
    - name: Create Pre-release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}-pre
        name: 2FMusic ${{ steps.version.outputs.version }}
        body: |
          ## è‡ªåŠ¨æ„å»ºçš„æµ‹è¯•ç‰ˆ

          ### æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
          - **è§¦å‘è€…**: @${{ github.actor }}
          - **äº‹ä»¶**: ${{ github.event_name }}
          
          ### å˜æ›´æ—¥å¿—
          ${{ steps.changelog.outputs.logs }}

          ---

          ### 1. Python æºç ç‰ˆ
          - **æ–‡ä»¶**: `${{ steps.build_source.outputs.source_pkg }}`
          - **ä¾èµ–**: ä¾èµ– Python ç¯å¢ƒ (`python312`)ã€‚
          
          ### 2. äºŒè¿›åˆ¶ç‰ˆï¼ˆæ¨èï¼‰
          - **æ–‡ä»¶**: `${{ steps.build_binary.outputs.binary_pkg }}`
          - **ä¾èµ–**: **æ— éœ€** Python ç¯å¢ƒï¼Œå¼€ç®±å³ç”¨ã€‚

          ### 3. é¢„è§ˆæ’­æ”¾æ‹“å±•ï¼ˆå¯é€‰ï¼‰
          - **æ–‡ä»¶**: `${{ steps.build_preview_cgi.outputs.pkg_name }}`
          - **è¯´æ˜**: Webç«¯æ–‡ä»¶ç®¡ç†å™¨åŒå‡»é¢„è§ˆæ’­æ”¾æ‹“å±•ï¼Œæ³¨æ„ï¼šæ­¤æ‹“å±•ä¼šå¯¼è‡´ç§»åŠ¨ç«¯APPéŸ³ä¹æ’­æ”¾å™¨å¤±æ•ˆï¼

          > âš ï¸ **é‡è¦æç¤º**ï¼šä¸ºé¿å…å…¼å®¹æ€§é—®é¢˜ï¼Œå®‰è£…æ–°ç‰ˆå‰å»ºè®®**å®Œå…¨å¸è½½æ—§ç‰ˆæœ¬å¹¶æ¸…é™¤æ•°æ®**ï¼

        files: |
          ${{ steps.build_source.outputs.source_pkg }}
          ${{ steps.build_binary.outputs.binary_pkg }}
          ${{ steps.build_preview_cgi.outputs.pkg_name }}
        prerelease: true
        make_latest: legacy
        draft: false
