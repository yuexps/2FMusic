name: Auto Build 2FMusic (Dual Versions)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1. ä» manifest æå–ç‰ˆæœ¬å·
    - name: Extract Version from Manifest
      id: version
      run: |
        VERSION=$(grep "^version" manifest | awk -F'=' '{print $2}' | xargs)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Detected version: ${VERSION}"

    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    # 3. å®‰è£…ç¼–è¯‘å·¥å…·å’Œç¯å¢ƒä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
        # è™½ç„¶ lib é‡Œå·²ç»æœ‰åº“äº†ï¼Œä½†ä¸ºäº†è®© PyInstaller èƒ½æ­£ç¡®åˆ†æå¹¶æ‰“åŒ…è¿›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéœ€è¦åœ¨ Runner çš„ä¸´æ—¶ç¯å¢ƒä¸­å®‰è£…è¿™äº›ä¾èµ–ã€‚
        if [ -f app/server/requirements.txt ]; then 
           pip install -r app/server/requirements.txt
        fi

    # 4. å®‰è£… fnpack
    - name: Install fnpack
      run: |
        wget https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64 -O fnpack
        chmod +x fnpack
        sudo mv fnpack /usr/local/bin/

    # ==========================================
    # 5. æ„å»ºç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼šæºç ç‰ˆ (Python Version)
    #    åˆ©ç”¨ä»“åº“è‡ªå¸¦çš„ lib ç›®å½•ç›´æ¥æ‰“åŒ…
    # ==========================================
    - name: Build Source Package (Requires Python)
      id: build_source
      run: |
        echo "ğŸ“¦ Building Source (Python) Package..."
        # ç›´æ¥ä½¿ç”¨è‡ªå¸¦çš„ lib ç›®å½•æ‰“åŒ…
        fnpack build
        
        # é‡å‘½åç”Ÿæˆçš„åŒ…
        SOURCE_FPK_NAME="2fmusic-${{ steps.version.outputs.version }}-python_src.fpk"
        mv *.fpk "$SOURCE_FPK_NAME"
        
        echo "source_pkg=${SOURCE_FPK_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Generated: $SOURCE_FPK_NAME"

    # ==========================================
    # 6. ç¯å¢ƒè½¬æ¢ï¼šç¼–è¯‘äºŒè¿›åˆ¶ & æ¸…ç†æºç 
    # ==========================================
    - name: Compile and Cleanup for Binary
      run: |
        echo "ğŸ”¨ Compiling app.py to binary..."
        # ç¼–è¯‘ä¸ºå•æ–‡ä»¶ï¼Œè¾“å‡ºåˆ° app/server/app
        pyinstaller --clean --onefile --name "app" --distpath "app/server" "app/server/app.py"
        
        # èµ‹äºˆæ‰§è¡Œæƒé™
        chmod +x app/server/app
        
        echo "ğŸ§¹ Cleaning up source files..."
        rm -rf build/
        rm -f app.spec
        
        # åˆ é™¤æºç å’Œä¾èµ–åº“
        rm -f app/server/app.py
        rm -rf app/server/lib
        
        echo "ğŸ“ Modifying manifest (Remove Python dependency)..."
        # ä» manifest ä¸­åˆ é™¤ install_dep_apps è¿™ä¸€è¡Œï¼Œå› ä¸ºäºŒè¿›åˆ¶ç‰ˆä¸éœ€è¦ç³»ç»Ÿå®‰è£… python
        sed -i '/install_dep_apps/d' manifest
        
        echo "âœ… Ready for Binary Build."

    # ==========================================
    # 7. æ„å»ºç¬¬äºŒä¸ªç‰ˆæœ¬ï¼šäºŒè¿›åˆ¶ç‰ˆ (Binary Version)
    # ==========================================
    - name: Build Binary Package (Standalone)
      id: build_binary
      run: |
        echo "ğŸ“¦ Building Binary (Standalone) Package..."
        fnpack build
        
        # é‡å‘½åç”Ÿæˆçš„åŒ…
        BINARY_FPK_NAME="2fmusic-${{ steps.version.outputs.version }}-bin_amd64.fpk"
        mv *.fpk "$BINARY_FPK_NAME"
        
        echo "binary_pkg=${BINARY_FPK_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Generated: $BINARY_FPK_NAME"

    # 8. åˆ é™¤æ—§çš„åŒç‰ˆæœ¬ Release
    - name: Delete old pre-releases
      run: |
        TAG="v${{ steps.version.outputs.version }}-pre"
        gh release delete "$TAG" --yes || true
        git push --delete origin "$TAG" || true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 9. åˆ›å»ºå‘å¸ƒå¹¶ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶
    - name: Create Pre-release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}-pre
        name: 2FMusic ${{ steps.version.outputs.version }} (Dual Versions)
        body: |
          ## ğŸš€ Auto-built Dual Release

          **Version**: ${{ steps.version.outputs.version }}

          æ­¤ Release åŒ…å«ä¸¤ä¸ªç‰ˆæœ¬çš„å®‰è£…åŒ…ï¼š

          ### 1. ğŸ Python Source Version (`-python_src.fpk`)
          - **æ–‡ä»¶**: `${{ steps.build_source.outputs.source_pkg }}`
          - **è¯´æ˜**: ä½¿ç”¨ä»“åº“è‡ªå¸¦ `lib` åº“ï¼Œä¿ç•™ `app.py` æºç ã€‚
          - **ä¾èµ–**: ä¾èµ–ç³»ç»Ÿ Python ç¯å¢ƒ (`python312`)ã€‚
          
          ### 2. âš¡ Binary Version (`-bin_amd64.fpk`)
          - **æ–‡ä»¶**: `${{ steps.build_binary.outputs.binary_pkg }}`
          - **è¯´æ˜**: æ ¸å¿ƒå·²ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ**ä¸å«æºç **ï¼Œå¯åŠ¨æ›´å¿«ã€‚
          - **ä¾èµ–**: **æ— éœ€**ç³»ç»Ÿ Python ç¯å¢ƒã€‚

          ### âš ï¸ Notes
          - è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‰ˆ (Pre-release)ã€‚

        files: |
          ${{ steps.build_source.outputs.source_pkg }}
          ${{ steps.build_binary.outputs.binary_pkg }}
        prerelease: true
        draft: false
