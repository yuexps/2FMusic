name: Build Extensions

on:
  workflow_dispatch:
  push:
    paths:
      - 'extensions/**'

jobs:
  build-extensions:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install fnpack
      run: |
        cp build/fnpack-1.2.1-linux-amd64 extensions/preview-cgi/fnpack
        chmod +x extensions/preview-cgi/fnpack

    # ===============================
    # Build 2FMusic Preview (CGI)
    # ===============================
    - name: Build Preview (CGI)
      id: build_preview_cgi
      run: |
        echo "ðŸ“¦ Building Preview Extension (CGI)..."
        cd extensions/preview-cgi
        
        # Compile C Code
        echo "ðŸ”¨ Compiling index.c..."
        gcc -static -O2 -o app/ui/index.cgi app/ui/index.c
        chmod +x app/ui/index.cgi
        rm app/ui/index.c
        
        # Package
        ./fnpack build
        
        # Get Version from Manifest
        VERSION=$(grep "^version" manifest | awk -F'=' '{print $2}' | tr -d '[:space:]')
        SHORT_SHA=$(git rev-parse --short HEAD)
        PKG_NAME="fnnas.2fmusic-preview-cgi-${VERSION}-${SHORT_SHA}.fpk"
        
        # Find and Move
        if [ -f "fnnas.2fmusic-preview-cgi.fpk" ]; then
          mv fnnas.2fmusic-preview-cgi.fpk "../../$PKG_NAME"
        else
          mv *.fpk "../../$PKG_NAME" || echo "Warning: No fpk found!"
        fi
        
        cd ../..
        echo "pkg_name=${PKG_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… Built: $PKG_NAME"

    - name: Upload CGI Extension
      uses: actions/upload-artifact@v4
      with:
        name: fnnas.2fmusic-preview-cgi
        path: ${{ steps.build_preview_cgi.outputs.pkg_name }}