<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>2FMusic</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" crossorigin="use-credentials">

    <meta name="mobile-web-app-capable" content="yes">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="2FMusic">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/ICON_256.PNG') }}">

    <meta name="theme-color" content="#000000">

    <script>
        (function () {
            // 初始化缩放：优先读取用户设置，如果没有则使用响应式缩放
            function initScale() {
                // 从 localStorage 读取用户保存的缩放设置
                const savedScale = localStorage.getItem('2fmusic_ui_scale');
                
                if (savedScale) {
                    // 如果有用户设置，直接使用
                    const userScale = parseFloat(savedScale);
                    applyScale(userScale);
                } else {
                    // 否则使用响应式缩放
                    setResponsiveScale();
                }
                
                // 监听窗口大小变化（仅在没有用户设置时使用响应式）
                window.addEventListener('resize', function() {
                    if (!localStorage.getItem('2fmusic_ui_scale')) {
                        setResponsiveScale();
                    }
                });
            }
            
            function setResponsiveScale() {
                if (window.innerWidth > 768) {
                    let scale = Math.min(Math.max(window.innerWidth / 1440, 0.8), 1.2);
                    document.documentElement.style.setProperty('--ui-scale', scale.toFixed(3));
                } else {
                    document.documentElement.style.setProperty('--ui-scale', '1.0');
                }
            }
            
            function applyScale(scale) {
                document.documentElement.style.setProperty('--ui-scale', scale.toFixed(3));
            }
            
            // 立即执行初始化
            initScale();
        })();
    </script>

    <link rel="icon" href="{{ url_for('static', filename='images/ICON_256.PNG') }}">
    <script src="{{ url_for('static', filename='js/lib/color-thief.umd.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        /* 设置页面样式 */
        .settings-page {
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-title i {
            color: var(--primary);
        }
        
        .scale-control {
            margin-top: 1rem;
        }
        
        .scale-slider-container {
            margin-bottom: 1rem;
        }
        
        .scale-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .scale-percent {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
        }
        
        #ui-scale-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }
        
        #ui-scale-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        
        #ui-scale-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .scale-presets {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .scale-preset-btn {
            flex: 1;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .scale-preset-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }
        
        .scale-preset-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .setting-item {
            margin-bottom: 1.5rem;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dim);
            font-size: 0.95rem;
        }
        
        .setting-hint {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 0.3rem;
            opacity: 0.8;
        }
        
        .settings-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .settings-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .settings-btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .settings-btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .settings-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .settings-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* 键盘快捷键提示 */
        .shortcut-hint {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            font-family: 'Monaco', 'Courier New', monospace;
            margin: 0 0.2rem;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .settings-page {
                padding: 1rem;
            }
            
            .settings-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .scale-presets {
                flex-wrap: wrap;
            }
            
            .scale-preset-btn {
                flex: calc(33.333% - 0.5rem);
            }
        }
    </style>
</head>

<body>

    <div id="app">
        <aside id="sidebar" class="glass-panel">
            <div class="brand">
                <a href="https://github.com/yuexps/2FMusic" target="_blank" class="icon-btn" title="View on GitHub"
                    style="color: var(--text-main); display: flex; align-items: center; text-decoration: none;">
                    <i class="fab fa-github" style="font-size: 2rem;"></i>
                </a>
                <span>2FMusic</span>
            </div>
            <nav>
                <ul>
                    <li class="active" id="nav-local"><i class="fas fa-music"></i> <span>本地音乐</span></li>
                    <li id="nav-fav"><i class="fas fa-heart"></i> <span>我的收藏</span></li>
                    <li id="nav-mount"><i class="fas fa-network-wired"></i> <span>目录管理</span></li>
                    <li id="nav-netease"><i class="fas fa-cloud-download-alt"></i> <span>网易下载</span></li>
                    <li id="nav-upload"><i class="fas fa-cloud-upload-alt"></i> <span>上传音乐</span></li>
                    <!-- 新增设置选项 -->
                    <li id="nav-settings"><i class="fas fa-cog"></i> <span>设置</span></li>
                </ul>
            </nav>
        </aside>

        <main id="main-content">
            <header class="top-bar">
                <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                <div id="mobile-page-title" class="mobile-title">本地音乐</div>
            </header>

            <div class="content-scroll">
                <!-- 原有页面内容保持不变 -->
                <div id="view-player">
                    <div class="content-header">
                        <div class="section-title" id="list-title">歌曲列表</div>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-input" placeholder="搜索本地歌曲...">
                        </div>
                    </div>
                    <div class="song-list" id="song-list-container">
                        <div class="loading">
                            <div class="loading-box">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-mount" class="hidden">
                    <div class="section-title">音乐目录管理</div>

                    <div class="mount-add-section glass-panel">
                        <h3><i class="fas fa-folder-plus"></i> 添加服务器目录</h3>
                        <p class="mount-hint">输入服务器上的文件夹绝对路径（例:/vol1/1000/music）自动监控并导入。</p>
                        <div class="mount-input-group">
                            <input type="text" id="mount-path-input" placeholder="输入绝对路径...">
                            <button id="btn-add-mount" class="btn-primary">添加</button>
                        </div>
                    </div>

                    <div class="section-subtitle">已添加目录</div>
                    <div id="mount-list-container">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <div id="view-netease" class="hidden">
                    <div class="netease-gate glass-panel hidden" id="netease-config-gate">
                        <div class="gate-header-block">
                            <div class="gate-title">配置网易云 API</div>
                            <div class="gate-desc">请选择一种方式连接网易云音乐 API 服务</div>
                        </div>

                        <div class="gate-options-container">
                            <!-- 方式 1: 自动安装 -->
                            <div class="gate-option-card active-card">
                                <div class="option-icon-box"><i class="fab fa-docker"></i></div>
                                <div class="option-content">
                                    <div class="option-title">自动安装 (推荐)</div>
                                    <div class="option-desc">服务器必须已安装 Docker 服务。我们将自动为您拉取镜像并启动服务。<br>无需手动操作，自动完成安装
                                    </div>
                                </div>
                                <button id="netease-api-install-btn" class="btn-primary full-width-btn">
                                    <i class="fas fa-magic"></i> 一键安装 & 连接
                                </button>

                                <div id="install-progress-container" class="hidden"
                                    style="width: 100%; margin-top: 1rem;">
                                    <div
                                        style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.3rem; color: rgba(255,255,255,0.8);">
                                        <span id="install-step-text">准备就绪</span>
                                        <span id="install-percent-text">0%</span>
                                    </div>
                                    <div
                                        style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                        <div id="install-progress-bar"
                                            style="width: 0%; height: 100%; background: var(--primary); transition: width 0.3s ease;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 方式 2: 手动配置 -->
                            <div class="gate-option-card">
                                <div class="option-icon-box"><i class="fas fa-network-wired"></i></div>
                                <div class="option-content">
                                    <div class="option-title">手动连接</div>
                                    <div class="option-desc">如果无法自动安装，请在 FnDepot 添加源 https://github.com/yuexps/FnDepot
                                        <br>手动下载
                                        网易云API 应用，然后输入地址连接。
                                    </div>
                                </div>
                                <div class="gate-manual-form">
                                    <input type="text" id="netease-api-gate-input" placeholder="http://localhost:23236"
                                        value="http://localhost:23236">
                                    <button id="netease-api-gate-btn" class="btn-normal full-width-btn">检测并连接</button>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="netease-container-new" id="netease-content">
                        <header class="netease-header">
                            <div class="netease-title-large">网易云下载</div>
                            <div class="netease-header-right">
                                <div id="netease-user-display" class="netease-user-display hidden">
                                    <div class="user-text">
                                        <div id="netease-user-name" class="user-name">User</div>
                                        <div class="user-tag">VIP</div>
                                    </div>
                                    <div class="vip-avatar-ring-wrapper">
                                        <div class="vip-badge-icon hidden" id="netease-vip-badge">V</div>
                                        <div class="" id="netease-avatar-wrapper">
                                            <img id="netease-user-avatar" src="" alt="Avatar">
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down user-dropdown-caret"></i>
                                    <div class="netease-user-menu hidden" id="netease-user-menu">
                                        <button id="netease-menu-logout" class="menu-btn danger"><i
                                                class="fas fa-sign-out-alt"></i> 退出登录</button>
                                    </div>
                                </div>
                                <button id="netease-login-btn-top" class="btn-primary-small">登录</button>
                                <button id="netease-settings-btn" class="icon-btn" title="设置"><i
                                        class="fas fa-cog"></i></button>
                                <button id="netease-download-floating" class="icon-btn" title="下载管理"><i
                                        class="fas fa-tasks"></i></button>
                            </div>
                        </header>

                        <!-- Download Panel (Overlay) -->
                        <div class="netease-download-panel hidden" id="netease-download-panel">
                            <div class="netease-download-header">
                                <div>
                                    <div class="netease-download-title">下载管理</div>
                                </div>
                                <button id="netease-download-toggle" class="icon-btn" title="关闭"><i
                                        class="fas fa-times"></i></button>
                            </div>
                            <div class="netease-download-list" id="netease-download-list">
                                <div class="loading-text">暂无下载</div>
                            </div>
                        </div>

                        <div class="netease-search-hero">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="netease-global-input" placeholder="搜索歌曲或粘贴歌曲/歌单链接 (Enter搜索)">
                            </div>
                        </div>

                        <div class="netease-results-area">


                            <div class="netease-bulk-actions hidden" id="netease-bulk-actions">
                                <label class="netease-check">
                                    <input type="checkbox" id="netease-select-all">
                                    <span>全选</span>
                                </label>
                                <button id="netease-bulk-download" class="btn-mini"><i class="fas fa-download"></i>
                                    下载选中</button>
                            </div>

                            <div id="netease-result-list" class="netease-result-list">
                                <!-- Empty State -->
                                <div class="netease-empty-state">
                                    <div class="empty-title">等待搜索...</div>
                                    <div class="empty-desc">请输入关键词开始</div>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden Settings Modal/Panel (Triggered by settings button) -->
                        <div id="netease-settings-modal" class="custom-overlay centered hidden">
                            <div class="glass-panel settings-box">
                                <h3>网易云设置</h3>
                                <div class="setting-row">
                                    <label>API 地址</label>
                                    <input type="text" id="netease-api-settings-input"
                                        placeholder="http://localhost:23236">
                                </div>
                                <div class="setting-row">
                                    <label>保存目录</label>
                                    <input type="text" id="netease-download-dir" placeholder="下载保存目录">
                                </div>

                                <button id="netease-change-api" class="btn-danger-block">断开 API 连接</button>
                                <div class="setting-actions">
                                    <button id="netease-save-dir" class="btn-primary">保存设置</button>
                                    <button id="netease-close-settings" class="btn-primary">关闭</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-upload" class="hidden">
                    <div class="upload-page glass-panel">
                        <h3>上传音乐</h3>
                        <p class="upload-desc">点击或拖拽文件到下方区域，可选择保存目录。</p>
                        <div class="upload-target">
                            <label for="upload-target-input">保存目录（仅可选择已添加的目录或默认库）</label>
                            <div class="upload-select" id="upload-target-select">
                                <div class="upload-select-current" id="upload-target-current" data-value="">默认音乐库</div>
                                <div class="upload-select-list hidden" id="upload-target-list"></div>
                            </div>
                            <input type="hidden" id="upload-target-input" value="">
                        </div>
                        <div id="upload-dropzone" class="upload-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div>拖拽文件到此，或点击选择</div>
                            <input type="file" id="file-upload" accept=".mp3,.flac,.wav,.ogg,.m4a" hidden>
                            <button id="upload-choose-btn" class="btn-primary">选择文件</button>
                        </div>
                        <div id="upload-status" class="upload-status"></div>
                    </div>
                </div>

                <!-- 新增设置页面 -->
                <div id="view-settings" class="hidden">
                    <div class="settings-page">
                        <div class="settings-section">
                            <div class="settings-title">
                                <i class="fas fa-desktop"></i>
                                界面设置
                            </div>
                            
                            <div class="setting-item">
                                <div class="scale-slider-header">
                                    <div class="setting-label">界面缩放</div>
                                    <div class="scale-percent" id="scale-percent">100%</div>
                                </div>
                                <div class="scale-slider-container">
                                    <input type="range" 
                                           id="ui-scale-slider" 
                                           min="0.6" 
                                           max="1.4" 
                                           step="0.05" 
                                           value="1.0">
                                </div>
                                
                                <div class="scale-presets">
                                    <button class="scale-preset-btn" data-scale="0.8">小 (80%)</button>
                                    <button class="scale-preset-btn active" data-scale="1.0">默认 (100%)</button>
                                    <button class="scale-preset-btn" data-scale="1.2">大 (120%)</button>
                                    <button class="scale-preset-btn" data-scale="1.4">最大 (140%)</button>
                                </div>
                                
                                <div class="setting-hint">
                                    当前缩放：<span id="current-scale-value">1.0</span> 
                                    • 快捷键：<span class="shortcut-hint">Ctrl + +</span>放大， 
                                    <span class="shortcut-hint">Ctrl + -</span>缩小， 
                                    <span class="shortcut-hint">Ctrl + 0</span>重置
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="auto-responsive-scale">
                                    启用响应式缩放
                                </label>
                                <div class="setting-hint">
                                    根据屏幕宽度自动调整缩放比例（默认开启，用户设置优先）
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-title">
                                <i class="fas fa-volume-up"></i>
                                播放器设置
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">默认音量</label>
                                <input type="range" 
                                       id="default-volume-slider" 
                                       min="0" 
                                       max="1" 
                                       step="0.05" 
                                       value="1">
                                <div class="setting-hint">
                                    设置播放器启动时的默认音量：<span id="volume-percent">100%</span>
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="auto-play-next">
                                    自动播放下一首
                                </label>
                                <div class="setting-hint">
                                    当前歌曲播放完成后自动播放下一首
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="show-lyrics">
                                    自动显示歌词
                                </label>
                                <div class="setting-hint">
                                    播放歌曲时自动显示歌词面板
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-title">
                                <i class="fas fa-database"></i>
                                数据管理
                            </div>
                            
                            <div class="setting-item">
                                <button class="settings-btn settings-btn-secondary" id="clear-cache-btn">
                                    <i class="fas fa-trash-alt"></i> 清除缓存数据
                                </button>
                                <div class="setting-hint">
                                    清除本地缓存，但保留收藏和设置
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <button class="settings-btn settings-btn-secondary" id="export-settings-btn">
                                    <i class="fas fa-download"></i> 导出设置
                                </button>
                                <button class="settings-btn settings-btn-secondary" id="import-settings-btn">
                                    <i class="fas fa-upload"></i> 导入设置
                                </button>
                                <div class="setting-hint">
                                    备份或恢复您的应用设置
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-actions">
                            <button class="settings-btn settings-btn-secondary" id="reset-settings-btn">
                                <i class="fas fa-undo-alt"></i> 重置设置
                            </button>
                            <button class="settings-btn settings-btn-primary" id="save-settings-btn">
                                <i class="fas fa-save"></i> 保存设置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer id="player-bar">
            <div class="player-info" id="open-detail-view" title="点击查看歌词">
                <img src="{{ url_for('static', filename='images/ICON_256.PNG') }}" id="current-cover" alt="Cover">
                <div class="info-text">
                    <div id="current-title">等待播放</div>
                    <div id="current-artist">2FMusic</div>
                </div>
            </div>

            <div class="player-controls">
                <div class="buttons">
                    <button class="icon-btn" id="btn-prev"><i class="fas fa-step-backward"></i></button>
                    <button class="play-btn" id="btn-play"><i class="fas fa-play"></i></button>
                    <button class="icon-btn" id="btn-next"><i class="fas fa-step-forward"></i></button>
                </div>
                <div class="progress-container">
                    <span id="time-current">0:00</span>
                    <input type="range" id="progress-bar" value="0" min="0" max="100" step="0.1">
                    <span id="time-total">0:00</span>
                </div>
            </div>

            <div class="player-extra">
                <button class="icon-btn" id="btn-mute" style="width: 2rem; text-align: center;">
                    <i class="fas fa-volume-up" id="vol-icon"></i>
                </button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
            </div>

            <button id="mobile-mini-play" class="icon-btn" style="display: none; font-size: 1.5rem; padding: 1rem;">
                <i class="fas fa-play"></i>
            </button>
        </footer>

        <div id="full-player-overlay">
            <div class="fp-header">
                <button id="close-detail-view"><i class="fas fa-chevron-down"></i></button>
                <span>正在播放</span>
                <div class="fp-header-right">
                    <button id="fp-menu-btn" class="icon-btn"><i class="fas fa-ellipsis-h"></i></button>
                </div>
            </div>

            <div class="fp-content">
                <div class="fp-art-area">
                    <img src="{{ url_for('static', filename='images/ICON_256.PNG') }}" id="fp-cover" alt="Cover">
                    <div class="fp-info">
                        <h2 id="fp-title">歌曲标题</h2>
                        <p id="fp-artist">歌手</p>
                    </div>
                </div>

                <div class="fp-lyrics-area no-lyrics" id="lyrics-container">
                    <p class="lyric-line active">暂无歌词</p>
                </div>
            </div>

            <div class="fp-controls">
                <div class="fp-progress-bar">
                    <span id="fp-time-current">0:00</span>
                    <input type="range" id="fp-progress-bar" value="0" min="0" max="100" step="0.1">
                    <span id="fp-time-total">0:00</span>
                </div>
                <div class="fp-buttons">
                    <button class="icon-btn" id="fp-btn-mode" title="切换模式"><i class="fas fa-redo"></i></button>
                    <button class="icon-btn" id="fp-btn-prev"><i class="fas fa-step-backward"></i></button>
                    <button class="play-btn play-huge" id="fp-btn-play"><i class="fas fa-play"></i></button>
                    <button class="icon-btn" id="fp-btn-next"><i class="fas fa-step-forward"></i></button>
                    <button class="icon-btn" id="fp-btn-fav" title="收藏"><i class="far fa-heart"></i></button>
                </div>
            </div>
        </div>

        <div id="upload-modal">
            <div class="upload-box glass-panel">
                <h3><i class="fas fa-cloud-upload-alt"></i> 上传文件</h3>
                <p id="upload-filename">filename.mp3</p>
                <div class="upload-progress-track">
                    <div class="upload-progress-fill" id="upload-progress-fill"></div>
                </div>
                <div class="upload-status">
                    <span id="upload-percent">0%</span>
                    <span id="upload-msg">准备中...</span>
                </div>
                <button id="close-upload-modal" class="icon-btn" style="margin-top: 1rem; display: none;">关闭</button>
            </div>
        </div>

        <div id="action-menu-overlay" class="custom-overlay">
            <div class="action-sheet glass-panel">
                <button class="action-item" id="action-rematch">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
                <button class="action-item" id="action-download">
                    <i class="fas fa-download"></i> 本地下载
                </button>
                <button class="action-item delete" id="action-delete">
                    <i class="fas fa-trash-alt"></i> 永久删除
                </button>
                <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 0.5rem 0;"></div>
                <button class="action-item cancel" id="action-cancel">取消</button>
            </div>
        </div>

        <div id="confirm-modal-overlay" class="custom-overlay">
            <div class="confirm-box glass-panel">
                <h3><i class="fas fa-exclamation-triangle"></i> 确认操作</h3>
                <p>确定要执行此操作吗？</p>
                <div class="confirm-buttons">
                    <button id="confirm-yes" class="btn-danger">确认</button>
                    <button id="confirm-no" class="btn-normal">取消</button>
                </div>
            </div>
        </div>

        <div id="netease-qr-modal" class="custom-overlay centered">
            <div class="qr-box glass-panel">
                <h3>扫码登录网易云</h3>
                <div class="netease-qr-box">
                    <img id="netease-qr-img" alt="扫码登录" src="" />
                    <div class="netease-qr-hint" id="netease-qr-hint">使用网易云音乐扫码</div>
                </div>
                <button id="close-qr-modal" class="btn-normal"
                    style="margin-top: 1rem; padding: 0.6rem 1.5rem; border-radius: 2rem;">取消</button>
            </div>
        </div>


        <!-- 通用确认模态框 -->
        <div class="overlay" id="confirm-modal-overlay">
            <div class="modal confirm-box">
                <h3>提示</h3>
                <p>确认执行此操作吗？</p>
                <div class="modal-buttons">
                    <button id="confirm-no" class="btn-normal">取消</button>
                    <button id="confirm-yes" class="btn-primary">确定</button>
                </div>
            </div>
        </div>

        <div id="toast-container"></div>
        <input type="file" id="file-upload" accept=".mp3,.flac,.wav,.ogg,.m4a" style="display: none;">
        <!-- 用于导入设置的隐藏文件输入 -->
        <input type="file" id="import-settings-file" accept=".json" style="display: none;">

    </div>

    <audio id="audio-player"></audio>
    <script>
        (function () {
            try {
                const saved = localStorage.getItem('2fmusic_state');
                const state = saved ? JSON.parse(saved) : {};
                const tab = state.tab || 'local';

                // 1. Restore FullScreen Overlay
                if (state.isFullScreen) {
                    const overlay = document.getElementById('full-player-overlay');
                    if (overlay) overlay.classList.add('active');
                }

                // 2. Tab & View
                document.querySelectorAll('nav li').forEach(el => el.classList.remove('active'));
                const targetNav = document.getElementById('nav-' + tab);
                if (targetNav) targetNav.classList.add('active');

                // 隐藏所有视图
                const allViews = ['view-player', 'view-mount', 'view-netease', 'view-upload', 'view-settings'];
                allViews.forEach(viewId => {
                    const view = document.getElementById(viewId);
                    if (view) view.classList.add('hidden');
                });

                // 显示当前视图
                if (tab === 'mount' && document.getElementById('view-mount')) {
                    document.getElementById('view-mount').classList.remove('hidden');
                } else if (tab === 'netease' && document.getElementById('view-netease')) {
                    document.getElementById('view-netease').classList.remove('hidden');
                } else if (tab === 'upload' && document.getElementById('view-upload')) {
                    document.getElementById('view-upload').classList.remove('hidden');
                } else if (tab === 'settings' && document.getElementById('view-settings')) {
                    document.getElementById('view-settings').classList.remove('hidden');
                } else if (document.getElementById('view-player')) {
                    document.getElementById('view-player').classList.remove('hidden');
                }

                // 3. Search Box logic
                const searchBox = document.querySelector('.search-box');
                if (searchBox) {
                    if (tab === 'local') {
                        searchBox.style.display = 'flex';
                        searchBox.style.opacity = '1';
                    } else {
                        searchBox.style.display = 'none';
                        searchBox.style.opacity = '0';
                    }
                }

                // 4. Volume
                if (state.volume !== undefined) {
                    const volSlider = document.getElementById('volume-slider');
                    if (volSlider) {
                        volSlider.value = state.volume;
                        volSlider.style.backgroundSize = (state.volume * 100) + '% 100%';
                    }
                }

                // 5. Current Song Info
                if (state.currentFilename) {
                    const playlist = JSON.parse(localStorage.getItem('2fmusic_playlist') || '[]');
                    const song = playlist.find(s => s.filename === state.currentFilename);
                    if (song) {
                        const title = song.title || song.filename;
                        const artist = song.artist || '未知艺术家';
                        const cover = song.album_art || song.cover || "{{ url_for('static', filename='images/ICON_256.PNG') }}";

                        ['current-title', 'fp-title'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.innerText = title;
                        });
                        ['current-artist', 'fp-artist'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.innerText = artist;
                        });
                        ['current-cover', 'fp-cover'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.src = cover;
                        });
                    }
                }

            } catch (e) { console.error('Fast init error', e); }
        })();
    </script>
    
    <script>
        // 设置页面功能脚本
        (function() {
            // 设置管理类
            class SettingsManager {
                constructor() {
                    this.defaultSettings = {
                        uiScale: 1.0,
                        autoResponsiveScale: true,
                        defaultVolume: 1.0,
                        autoPlayNext: true,
                        showLyrics: true,
                        theme: 'dark',
                        language: 'zh-CN'
                    };
                    
                    this.currentSettings = {};
                    this.init();
                }
                
                init() {
                    this.loadSettings();
                    this.bindEvents();
                    this.updateUI();
                    this.initKeyboardShortcuts();
                }
                
                loadSettings() {
                    try {
                        const saved = localStorage.getItem('2fmusic_settings');
                        if (saved) {
                            this.currentSettings = JSON.parse(saved);
                        } else {
                            this.currentSettings = { ...this.defaultSettings };
                            this.saveToStorage();
                        }
                    } catch (e) {
                        console.error('Failed to load settings:', e);
                        this.currentSettings = { ...this.defaultSettings };
                    }
                }
                
                saveToStorage() {
                    try {
                        localStorage.setItem('2fmusic_settings', JSON.stringify(this.currentSettings));
                    } catch (e) {
                        console.error('Failed to save settings:', e);
                    }
                }
                
                updateSetting(key, value) {
                    this.currentSettings[key] = value;
                    this.saveToStorage();
                    
                    // 立即应用某些设置
                    this.applySetting(key, value);
                    
                    return this;
                }
                
                applySetting(key, value) {
                    switch(key) {
                        case 'uiScale':
                            this.applyUIScale(value);
                            break;
                        case 'defaultVolume':
                            this.applyDefaultVolume(value);
                            break;
                        // 其他设置的应用逻辑
                    }
                }
                
                applyUIScale(scale) {
                    // 如果启用了响应式缩放且这是用户设置
                    if (this.currentSettings.autoResponsiveScale && 
                        localStorage.getItem('2fmusic_ui_scale') !== null) {
                        // 使用纯用户设置（不混合响应式）
                        document.documentElement.style.setProperty('--ui-scale', scale.toFixed(3));
                    } else if (this.currentSettings.autoResponsiveScale) {
                        // 使用响应式缩放
                        const baseScale = window.innerWidth > 768 ? 
                            Math.min(Math.max(window.innerWidth / 1440, 0.8), 1.2) : 1.0;
                        const finalScale = scale * baseScale;
                        document.documentElement.style.setProperty('--ui-scale', finalScale.toFixed(3));
                    } else {
                        // 使用固定缩放
                        document.documentElement.style.setProperty('--ui-scale', scale.toFixed(3));
                    }
                    
                    // 单独保存缩放值到专用存储
                    localStorage.setItem('2fmusic_ui_scale', scale.toString());
                }
                
                applyDefaultVolume(volume) {
                    const audioPlayer = document.getElementById('audio-player');
                    if (audioPlayer) {
                        audioPlayer.volume = volume;
                    }
                    
                    const volumeSlider = document.getElementById('volume-slider');
                    if (volumeSlider) {
                        volumeSlider.value = volume;
                    }
                }
                
                resetToDefaults() {
                    this.currentSettings = { ...this.defaultSettings };
                    this.saveToStorage();
                    this.updateUI();
                    this.applyAllSettings();
                    return this;
                }
                
                applyAllSettings() {
                    Object.keys(this.currentSettings).forEach(key => {
                        this.applySetting(key, this.currentSettings[key]);
                    });
                }
                
                exportSettings() {
                    const dataStr = JSON.stringify(this.currentSettings, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `2fmusic_settings_${new Date().toISOString().slice(0,10)}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    this.showToast('设置已导出');
                }
                
                importSettings(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            this.currentSettings = { ...this.defaultSettings, ...imported };
                            this.saveToStorage();
                            this.updateUI();
                            this.applyAllSettings();
                            this.showToast('设置已导入并应用');
                        } catch (error) {
                            this.showToast('导入失败：文件格式错误', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
                
                bindEvents() {
                    // 缩放滑块
                    const scaleSlider = document.getElementById('ui-scale-slider');
                    if (scaleSlider) {
                        // 设置初始值
                        scaleSlider.value = this.currentSettings.uiScale;
                        this.updateScaleDisplay(this.currentSettings.uiScale);
                        
                        scaleSlider.addEventListener('input', (e) => {
                            const scale = parseFloat(e.target.value);
                            this.updateSetting('uiScale', scale);
                            this.updateScaleDisplay(scale);
                            this.updatePresetButtons(scale);
                        });
                    }
                    
                    // 缩放预设按钮
                    document.querySelectorAll('.scale-preset-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const scale = parseFloat(btn.dataset.scale);
                            this.updateSetting('uiScale', scale);
                            if (scaleSlider) scaleSlider.value = scale;
                            this.updateScaleDisplay(scale);
                            this.updatePresetButtons(scale);
                        });
                    });
                    
                    // 响应式缩放开关
                    const autoScaleCheckbox = document.getElementById('auto-responsive-scale');
                    if (autoScaleCheckbox) {
                        autoScaleCheckbox.checked = this.currentSettings.autoResponsiveScale;
                        autoScaleCheckbox.addEventListener('change', (e) => {
                            this.updateSetting('autoResponsiveScale', e.target.checked);
                            // 重新应用缩放设置
                            this.applyUIScale(this.currentSettings.uiScale);
                        });
                    }
                    
                    // 默认音量滑块
                    const volumeSlider = document.getElementById('default-volume-slider');
                    if (volumeSlider) {
                        volumeSlider.value = this.currentSettings.defaultVolume;
                        this.updateVolumeDisplay(this.currentSettings.defaultVolume);
                        
                        volumeSlider.addEventListener('input', (e) => {
                            const volume = parseFloat(e.target.value);
                            this.updateSetting('defaultVolume', volume);
                            this.updateVolumeDisplay(volume);
                        });
                    }
                    
                    // 其他设置
                    ['autoPlayNext', 'showLyrics'].forEach(id => {
                        const checkbox = document.getElementById(id);
                        if (checkbox) {
                            checkbox.checked = this.currentSettings[id] || this.defaultSettings[id];
                            checkbox.addEventListener('change', (e) => {
                                this.updateSetting(id, e.target.checked);
                            });
                        }
                    });
                    
                    // 操作按钮
                    document.getElementById('save-settings-btn')?.addEventListener('click', () => {
                        this.saveToStorage();
                        this.showToast('设置已保存');
                    });
                    
                    document.getElementById('reset-settings-btn')?.addEventListener('click', () => {
                        if (confirm('确定要重置所有设置吗？此操作不可撤销。')) {
                            this.resetToDefaults();
                            this.showToast('设置已重置为默认值');
                        }
                    });
                    
                    document.getElementById('clear-cache-btn')?.addEventListener('click', () => {
                        if (confirm('确定要清除缓存数据吗？这将清除播放列表等临时数据，但保留您的设置和收藏。')) {
                            this.clearCache();
                            this.showToast('缓存已清除');
                        }
                    });
                    
                    document.getElementById('export-settings-btn')?.addEventListener('click', () => {
                        this.exportSettings();
                    });
                    
                    document.getElementById('import-settings-btn')?.addEventListener('click', () => {
                        document.getElementById('import-settings-file').click();
                    });
                    
                    document.getElementById('import-settings-file')?.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            this.importSettings(e.target.files[0]);
                            e.target.value = ''; // 清除选择
                        }
                    });
                    
                    // 导航到设置页面
                    document.getElementById('nav-settings')?.addEventListener('click', () => {
                        this.navigateToSettings();
                    });
                }
                
                updateScaleDisplay(scale) {
                    const percent = Math.round(scale * 100);
                    const percentElement = document.getElementById('scale-percent');
                    const valueElement = document.getElementById('current-scale-value');
                    
                    if (percentElement) percentElement.textContent = `${percent}%`;
                    if (valueElement) valueElement.textContent = scale.toFixed(2);
                    
                    // 更新滑块背景
                    const slider = document.getElementById('ui-scale-slider');
                    if (slider) {
                        const min = parseFloat(slider.min);
                        const max = parseFloat(slider.max);
                        const percentPos = ((scale - min) / (max - min)) * 100;
                        
                        slider.style.background = `linear-gradient(to right, 
                            var(--primary) 0%, 
                            var(--primary) ${percentPos}%, 
                            rgba(255, 255, 255, 0.1) ${percentPos}%, 
                            rgba(255, 255, 255, 0.1) 100%)`;
                    }
                }
                
                updateVolumeDisplay(volume) {
                    const percent = Math.round(volume * 100);
                    const percentElement = document.getElementById('volume-percent');
                    if (percentElement) percentElement.textContent = `${percent}%`;
                }
                
                updatePresetButtons(currentScale) {
                    document.querySelectorAll('.scale-preset-btn').forEach(btn => {
                        const scale = parseFloat(btn.dataset.scale);
                        btn.classList.toggle('active', Math.abs(scale - currentScale) < 0.01);
                    });
                }
                
                updateUI() {
                    // 更新所有UI元素以反映当前设置
                    this.updateScaleDisplay(this.currentSettings.uiScale);
                    this.updateVolumeDisplay(this.currentSettings.defaultVolume);
                    this.updatePresetButtons(this.currentSettings.uiScale);
                }
                
                clearCache() {
                    // 清除播放列表等临时数据，但保留设置和收藏
                    const keysToKeep = ['2fmusic_settings', '2fmusic_ui_scale', '2fmusic_favorites'];
                    const keysToRemove = [];
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('2fmusic_') && !keysToKeep.includes(key)) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // 重新加载页面以应用更改
                    setTimeout(() => location.reload(), 1000);
                }
                
                navigateToSettings() {
                    // 导航到设置页面
                    document.querySelectorAll('nav li').forEach(el => el.classList.remove('active'));
                    document.getElementById('nav-settings')?.classList.add('active');
                    
                    // 隐藏所有视图，显示设置视图
                    const allViews = ['view-player', 'view-mount', 'view-netease', 'view-upload', 'view-settings'];
                    allViews.forEach(viewId => {
                        const view = document.getElementById(viewId);
                        if (view) view.classList.add('hidden');
                    });
                    
                    const settingsView = document.getElementById('view-settings');
                    if (settingsView) {
                        settingsView.classList.remove('hidden');
                    }
                    
                    // 更新页面标题
                    const pageTitle = document.getElementById('mobile-page-title');
                    if (pageTitle) pageTitle.textContent = '设置';
                    
                    // 隐藏搜索框
                    const searchBox = document.querySelector('.search-box');
                    if (searchBox) {
                        searchBox.style.display = 'none';
                        searchBox.style.opacity = '0';
                    }
                    
                    // 保存当前标签页状态
                    try {
                        const state = JSON.parse(localStorage.getItem('2fmusic_state') || '{}');
                        state.tab = 'settings';
                        localStorage.setItem('2fmusic_state', JSON.stringify(state));
                    } catch (e) {
                        console.error('Failed to save tab state:', e);
                    }
                }
                
                initKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        // 检查是否在输入框中
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                            return;
                        }
                        
                        const scaleSlider = document.getElementById('ui-scale-slider');
                        if (!scaleSlider) return;
                        
                        let currentScale = this.currentSettings.uiScale;
                        const minScale = parseFloat(scaleSlider.min);
                        const maxScale = parseFloat(scaleSlider.max);
                        const step = parseFloat(scaleSlider.step);
                        
                        if ((e.ctrlKey || e.metaKey) && e.key === '=') {
                            // Ctrl + + 放大
                            e.preventDefault();
                            const newScale = Math.min(currentScale + step, maxScale);
                            this.updateSetting('uiScale', newScale);
                            scaleSlider.value = newScale;
                            this.updateScaleDisplay(newScale);
                            this.updatePresetButtons(newScale);
                            this.showToast(`缩放: ${Math.round(newScale * 100)}%`);
                        }
                        
                        if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                            // Ctrl + - 缩小
                            e.preventDefault();
                            const newScale = Math.max(currentScale - step, minScale);
                            this.updateSetting('uiScale', newScale);
                            scaleSlider.value = newScale;
                            this.updateScaleDisplay(newScale);
                            this.updatePresetButtons(newScale);
                            this.showToast(`缩放: ${Math.round(newScale * 100)}%`);
                        }
                        
                        if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                            // Ctrl + 0 重置缩放
                            e.preventDefault();
                            this.updateSetting('uiScale', 1.0);
                            scaleSlider.value = 1.0;
                            this.updateScaleDisplay(1.0);
                            this.updatePresetButtons(1.0);
                            this.showToast('缩放已重置为默认值');
                        }
                        
                        if ((e.ctrlKey || e.metaKey) && e.key === 'S' && !e.shiftKey) {
                            // Ctrl + S 保存设置
                            e.preventDefault();
                            this.saveToStorage();
                            this.showToast('设置已保存');
                        }
                    });
                }
                
                showToast(message, type = 'success') {
                    const toastContainer = document.getElementById('toast-container');
                    if (!toastContainer) return;
                    
                    const toast = document.createElement('div');
                    toast.className = `toast toast-${type}`;
                    toast.textContent = message;
                    
                    toastContainer.appendChild(toast);
                    
                    // 添加样式
                    toast.style.cssText = `
                        position: fixed;
                        bottom: 100px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: ${type === 'error' ? '#ff4757' : 'var(--primary)'};
                        color: white;
                        padding: 0.8rem 1.2rem;
                        border-radius: 0.5rem;
                        font-size: 0.9rem;
                        z-index: 9999;
                        animation: toastSlideUp 0.3s ease;
                    `;
                    
                    // 添加动画
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes toastSlideUp {
                            from {
                                opacity: 0;
                                transform: translateX(-50%) translateY(20px);
                            }
                            to {
                                opacity: 1;
                                transform: translateX(-50%) translateY(0);
                            }
                        }
                        
                        .toast {
                            animation: toastSlideUp 0.3s ease;
                        }
                        
                        .toast::before {
                            content: '✓';
                            margin-right: 0.5rem;
                        }
                        
                        .toast-error::before {
                            content: '✗';
                        }
                    `;
                    document.head.appendChild(style);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateX(-50%) translateY(-10px)';
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);
                }
            }
            
            // 页面加载完成后初始化设置管理器
            document.addEventListener('DOMContentLoaded', () => {
                window.settingsManager = new SettingsManager();
                
                // 确保CSS变量已定义
                if (!document.documentElement.style.getPropertyValue('--ui-scale')) {
                    document.documentElement.style.setProperty('--ui-scale', '1.0');
                }
            });
        })();
    </script>
    
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>